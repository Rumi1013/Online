{%- comment -%}
  Product template with enhanced features for Midnight Magnolia theme
{%- endcomment -%}

<section class="product-section animate-fade-in" style="padding: 2rem 0 4rem;">
  <div class="container">
    <div class="product-layout">
      {%- comment -%} Product Images {%- endcomment -%}
      <div class="product-media animate-fade-in-left">
        <div class="product-gallery">
          {%- if product.featured_media -%}
            <div class="product-image-main">
              <img 
                src="{{ product.featured_media | image_url: width: 600 }}" 
                alt="{{ product.featured_media.alt | escape }}"
                loading="lazy"
                class="product-image"
              >
            </div>
          {%- endif -%}
          
          {%- if product.media.size > 1 -%}
            <div class="product-thumbnails">
              {%- for media in product.media limit: 5 -%}
                <button class="thumbnail {% if forloop.first %}active{% endif %}" data-media-id="{{ media.id }}">
                  <img 
                    src="{{ media.preview_image | image_url: width: 100 }}" 
                    alt="{{ media.alt | escape }}"
                    loading="lazy"
                  >
                </button>
              {%- endfor -%}
            </div>
          {%- endif -%}
        </div>
      </div>

      {%- comment -%} Product Information {%- endcomment -%}
      <div class="product-info animate-fade-in-right">
        <div class="product-header">
          {%- if product.metafields.midnight_magnolia.coming_soon -%}
            <span class="product-badge coming-soon">âœ¨ Coming Soon</span>
          {%- endif -%}
          {%- if product.metafields.midnight_magnolia.bestseller -%}
            <span class="product-badge bestseller">ðŸŒŸ Bestseller</span>
          {%- endif -%}
          
          <h1 class="product-title">{{ product.title }}</h1>
          
          {%- if product.vendor != blank -%}
            <p class="product-vendor">by {{ product.vendor }}</p>
          {%- endif -%}

          <div class="product-price">
            {%- if product.compare_at_price > product.price -%}
              <span class="price-compare">{{ product.compare_at_price | money }}</span>
              <span class="price-current sale">{{ product.price | money }}</span>
              <span class="price-save">Save {{ product.compare_at_price | minus: product.price | money }}</span>
            {%- else -%}
              <span class="price-current">{{ product.price | money }}</span>
            {%- endif -%}
          </div>
        </div>

        {%- comment -%} Product Tabs {%- endcomment -%}
        <div class="product-tabs animate-fade-in-up" style="animation-delay: 0.2s;">
          <div class="tab-buttons">
            <button class="tab-btn active" data-tab="description">Description</button>
            <button class="tab-btn" data-tab="features">Features</button>
            <button class="tab-btn" data-tab="shipping">Shipping</button>
          </div>

          <div class="tab-content">
            <div class="tab-panel active" id="description">
              <div class="product-description">
                {{ product.description }}
              </div>
            </div>

            <div class="tab-panel" id="features">
              <div class="product-features-content">
                {%- if product.metafields.midnight_magnolia.product_format -%}
                  <p><strong>Format:</strong> {{ product.metafields.midnight_magnolia.product_format }}</p>
                {%- endif -%}
                {%- if product.metafields.midnight_magnolia.category_tag -%}
                  <p><strong>Category:</strong> {{ product.metafields.midnight_magnolia.category_tag }}</p>
                {%- endif -%}
                <p><strong>SKU:</strong> {{ product.selected_or_first_available_variant.sku | default: 'N/A' }}</p>
                <p><strong>Weight:</strong> {{ product.selected_or_first_available_variant.weight | weight_with_unit }}</p>
              </div>
            </div>

            <div class="tab-panel" id="shipping">
              <div class="shipping-info">
                <h4>Shipping Information</h4>
                <p>Free shipping on orders over $75. Orders typically ship within 1-2 business days.</p>
                <p>Digital downloads are available immediately after purchase.</p>
              </div>
            </div>
          </div>
        </div>

        {%- comment -%} Product Form {%- endcomment -%}
        <div class="product-form-container animate-fade-in-up" style="animation-delay: 0.3s;">
          <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" class="product-form" id="product-form-{{ product.id }}">
            {%- unless product.has_only_default_variant -%}
              <div class="product-variants">
                {%- for option in product.options_with_values -%}
                  <fieldset class="variant-input-wrap">
                    <legend class="variant-input-label">{{ option.name }}</legend>
                    {%- for value in option.values -%}
                      <input 
                        type="radio" 
                        id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                        name="{{ option.name }}" 
                        value="{{ value | escape }}"
                        form="{{ product_form_id }}"
                        {% if option.selected_value == value %}checked{% endif %}
                      >
                      <label for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}">
                        {{ value }}
                      </label>
                    {%- endfor -%}
                  </fieldset>
                {%- endfor -%}
              </div>
            {%- endunless -%}

            <div class="product-form-buttons">
              <div class="quantity-selector">
                <label for="quantity">Quantity:</label>
                <quantity-input class="quantity">
                  <button class="quantity__button" name="minus" type="button">
                    <span class="visually-hidden">Decrease quantity</span>
                    âˆ’
                  </button>
                  <input 
                    class="quantity__input" 
                    type="number" 
                    name="quantity" 
                    id="quantity" 
                    min="1" 
                    value="1"
                  >
                  <button class="quantity__button" name="plus" type="button">
                    <span class="visually-hidden">Increase quantity</span>
                    +
                  </button>
                </quantity-input>
              </div>

              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
              
              {%- if product.available -%}
                <button type="submit" class="btn btn--primary btn--full add-to-cart-btn">
                  <span class="btn-text">âœ¨ Add to Sacred Collection</span>
                  <span class="btn-loading" style="display: none;">Adding...</span>
                </button>
              {%- else -%}
                <button type="button" class="btn btn--primary btn--full" disabled>
                  Sold Out
                </button>
              {%- endif -%}

              <button type="button" class="btn btn--secondary btn--full wishlist-btn">
                ðŸ’– Add to Wishlist
              </button>
            </div>
          </form>

          {%- comment -%} Product Features {%- endcomment -%}
          <div class="product-features animate-fade-in-up" style="animation-delay: 0.4s;">
            <div class="features-grid">
              {%- if product.metafields.midnight_magnolia.product_format contains 'Digital' -%}
                <div class="feature">
                  <div class="feature-icon">ðŸ“±</div>
                  <div class="feature-text">
                    <h4>Instant Download</h4>
                    <p>Available immediately after purchase</p>
                  </div>
                </div>
              {%- endif -%}
              
              <div class="feature">
                <div class="feature-icon">ðŸŒ™</div>
                <div class="feature-text">
                  <h4>Mystical Design</h4>
                  <p>Crafted with sacred intention</p>
                </div>
              </div>
              
              <div class="feature">
                <div class="feature-icon">ðŸ’«</div>
                <div class="feature-text">
                  <h4>High Quality</h4>
                  <p>Premium materials and printing</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Quantity controls
  function updateQuantity(change) {
    const quantityField = document.querySelector('#quantity');
    const currentValue = parseInt(quantityField.value);
    const newValue = Math.max(1, currentValue + change);
    quantityField.value = newValue;
  }

  // Tab functionality
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabId = btn.dataset.tab;

      // Update active tab button
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Update active tab panel
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    });
  });

  // Add to cart functionality
  document.querySelector('.product-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const addButton = document.querySelector('.add-to-cart-btn');
    const btnText = addButton.querySelector('.btn-text');
    const btnLoading = addButton.querySelector('.btn-loading');

    // Show loading state
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    addButton.disabled = true;

    fetch('/cart/add.js', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      // Success - could trigger cart drawer or notification
      btnText.textContent = 'âœ¨ Added to Collection!';
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';

      setTimeout(() => {
        btnText.textContent = 'âœ¨ Add to Sacred Collection';
        addButton.disabled = false;
      }, 2000);
    })
    .catch(error => {
      console.error('Error:', error);
      btnText.textContent = 'Error - Try Again';
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      addButton.disabled = false;
    });
  });
</script>

{%- comment -%} Product Schema Markup {%- endcomment -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Product",
  "name": "{{ product.title | escape }}",
  "description": "{{ product.description | strip_html | escape }}",
  "image": [
    {%- for media in product.media -%}
      "{{ media | image_url: width: 1200 }}"{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ],
  "brand": {
    "@type": "Brand",
    "name": "{{ product.vendor | default: shop.name | escape }}"
  },
  "offers": {
    "@type": "Offer",
    "url": "{{ shop.url }}{{ product.url }}",
    "priceCurrency": "{{ cart.currency.iso_code }}",
    "price": "{{ product.price | divided_by: 100.0 }}",
    "availability": "{% if product.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}"
  }
}
</script>