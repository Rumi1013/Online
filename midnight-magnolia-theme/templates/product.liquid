{%- comment -%}
  MIDNIGHT MAGNOLIA THEME
  Product Template - Sacred Tools Product Page
  Spiritual wellness and healing tools theme
{%- endcomment -%}

<div class="product-page celestial-bg">

  {%- comment -%} Product Hero Section {%- endcomment -%}
  <section class="product-hero section">
    <div class="container">
      <div class="grid grid--2-col" style="gap: 3rem; align-items: start;">

        {%- comment -%} Product Images {%- endcomment -%}
        <div class="product-media">
          {%- if product.media.size > 0 -%}
            <div class="product-media__main">
              <div class="product-image animate-fade-in">
                <img src="{{ product.featured_media | image_url: width: 600 }}"
                     alt="{{ product.featured_media.alt | escape }}"
                     id="main-product-image">
              </div>

              {%- comment -%} Product Badges {%- endcomment -%}
              <div class="product-badges">
                {%- if product.metafields.midnight_magnolia.bestseller -%}
                  <span class="badge badge--bestseller">‚ú® Bestseller</span>
                {%- endif -%}
                {%- if product.metafields.midnight_magnolia.coming_soon -%}
                  <span class="badge badge--coming-soon">üåô Coming Soon</span>
                {%- endif -%}
                {%- if product.metafields.midnight_magnolia.product_format contains 'Digital' -%}
                  <span class="badge badge--digital">üí´ Digital Download</span>
                {%- endif -%}
              </div>
            </div>

            {%- if product.media.size > 1 -%}
              <div class="product-media__thumbnails">
                {%- for media in product.media limit: 5 -%}
                  <button class="thumbnail {% if forloop.first %}active{% endif %}"
                          data-media-id="{{ media.id }}"
                          onclick="changeMainImage('{{ media | image_url: width: 600 }}', this)">
                    <img src="{{ media | image_url: width: 100 }}"
                         alt="{{ media.alt | escape }}">
                  </button>
                {%- endfor -%}
              </div>
            {%- endif -%}
          {%- else -%}
            <div class="product-media__placeholder">
              {{ 'magnolia-flower.svg' | asset_url | img_tag: '', 'width: 200px; height: 200px; opacity: 0.3;' }}
            </div>
          {%- endif -%}
        </div>

        {%- comment -%} Product Information {%- endcomment -%}
        <div class="product-info">
          <div class="product-header animate-fade-in-up">
            {%- if product.metafields.midnight_magnolia.category_tag -%}
              <span class="product-category">{{ product.metafields.midnight_magnolia.category_tag }}</span>
            {%- endif -%}

            <h1 class="product-title">{{ product.title }}</h1>

            {%- if product.vendor != blank -%}
              <p class="product-vendor">by {{ product.vendor }}</p>
            {%- endif -%}

            <div class="product-rating">
              {%- comment -%} Star rating placeholder - integrate with review app {%- endcomment -%}
              <div class="stars">
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
              </div>
              <span class="rating-count">({{ product.metafields.reviews.rating_count | default: '12' }} reviews)</span>
            </div>
          </div>

          {%- comment -%} Product Price {%- endcomment -%}
          <div class="product-price animate-fade-in-up" style="animation-delay: 0.1s;">
            {%- if product.compare_at_price > product.price -%}
              <span class="price price--sale">{{ product.price | money }}</span>
              <span class="price price--compare">{{ product.compare_at_price | money }}</span>
              <span class="price-savings">Save {{ product.compare_at_price | minus: product.price | money }}</span>
            {%- else -%}
              <span class="price">{{ product.price | money }}</span>
            {%- endif -%}
          </div>

          {%- comment -%} Product Description {%- endcomment -%}
          {%- if product.description != blank -%}
            <div class="product-description animate-fade-in-up" style="animation-delay: 0.2s;">
              {{ product.description }}
            </div>
          {%- endif -%}

          {%- comment -%} Product Form {%- endcomment -%}
          <form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form animate-fade-in-up" style="animation-delay: 0.3s;">

            {%- comment -%} Product Variants {%- endcomment -%}
            {%- if product.variants.size > 1 -%}
              <div class="product-variants">
                {%- for option in product.options_with_values -%}
                  <div class="variant-option">
                    <label class="variant-label">{{ option.name }}</label>
                    <select name="id" class="variant-select form-select">
                      {%- for value in option.values -%}
                        {%- assign variant = product.variants | where: option.name, value | first -%}
                        <option value="{{ variant.id }}"
                                {% if variant == product.selected_or_first_available_variant %}selected{% endif %}
                                {% unless variant.available %}disabled{% endunless %}>
                          {{ value }}
                          {%- unless variant.available %} - Sold Out{% endunless -%}
                          {%- if variant.price != product.price %} - {{ variant.price | money }}{% endif -%}
                        </option>
                      {%- endfor -%}
                    </select>
                  </div>
                {%- endfor -%}
              </div>
            {%- else -%}
              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
            {%- endif -%}

            {%- comment -%} Quantity Selector {%- endcomment -%}
            <div class="quantity-selector">
              <label for="quantity" class="quantity-label">Quantity</label>
              <div class="quantity-input">
                <button type="button" class="quantity-btn quantity-minus" onclick="changeQuantity(-1)">-</button>
                <input type="number" id="quantity" name="quantity" value="1" min="1" class="quantity-field">
                <button type="button" class="quantity-btn quantity-plus" onclick="changeQuantity(1)">+</button>
              </div>
            </div>

            {%- comment -%} Add to Cart Button {%- endcomment -%}
            <div class="product-actions">
              {%- if product.metafields.midnight_magnolia.coming_soon -%}
                <button type="button" class="btn btn--primary btn--full" disabled>
                  üåô Coming Soon - Notify Me
                </button>
              {%- elsif product.available -%}
                <button type="submit" class="btn btn--primary btn--full add-to-cart-btn">
                  <span class="btn-text">‚ú® Add to Sacred Collection</span>
                  <span class="btn-loading" style="display: none;">Adding...</span>
                </button>
              {%- else -%}
                <button type="button" class="btn btn--primary btn--full" disabled>
                  Sold Out
                </button>
              {%- endif -%}

              <button type="button" class="btn btn--secondary btn--full wishlist-btn">
                üíñ Add to Wishlist
              </button>
            </div>
          </form>

          {%- comment -%} Product Features {%- endcomment -%}
          <div class="product-features animate-fade-in-up" style="animation-delay: 0.4s;">
            <div class="features-grid">
              {%- if product.metafields.midnight_magnolia.product_format contains 'Digital' -%}
                <div class="feature">
                  <div class="feature-icon">üì±</div>
                  <div class="feature-text">
                    <h4>Instant Download</h4>
                    <p>Access immediately after purchase</p>
                  </div>
                </div>
              {%- endif -%}

              <div class="feature">
                <div class="feature-icon">üåô</div>
                <div class="feature-text">
                  <h4>Intentionally Crafted</h4>
                  <p>Created with love and spiritual guidance</p>
                </div>
              </div>

              <div class="feature">
                <div class="feature-icon">üí´</div>
                <div class="feature-text">
                  <h4>Lifetime Access</h4>
                  <p>Yours to keep and revisit anytime</p>
                </div>
              </div>

              <div class="feature">
                <div class="feature-icon">üå∏</div>
                <div class="feature-text">
                  <h4>Community Support</h4>
                  <p>Join our healing circle for guidance</p>
                </div>
              </div>
            </div>
          </div>

          {%- comment -%} Social Sharing {%- endcomment -%}
          <div class="product-share animate-fade-in-up" style="animation-delay: 0.5s;">
            <h4>Share this Sacred Tool</h4>
            <div class="share-buttons">
              <a href="https://www.facebook.com/sharer/sharer.php?u={{ shop.url }}{{ product.url }}"
                 target="_blank" class="share-btn share-facebook">
                Facebook
              </a>
              <a href="https://twitter.com/intent/tweet?url={{ shop.url }}{{ product.url }}&text={{ product.title | url_encode }}"
                 target="_blank" class="share-btn share-twitter">
                Twitter
              </a>
              <a href="https://pinterest.com/pin/create/button/?url={{ shop.url }}{{ product.url }}&media={{ product.featured_media | image_url: width: 600 }}&description={{ product.title | url_encode }}"
                 target="_blank" class="share-btn share-pinterest">
                Pinterest
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  {%- comment -%} Product Details Tabs {%- endcomment -%}
  <section class="product-details section">
    <div class="container">
      <div class="product-tabs">
        <div class="tab-nav">
          <button class="tab-btn active" data-tab="description">Description</button>
          <button class="tab-btn" data-tab="details">Details</button>
          <button class="tab-btn" data-tab="reviews">Reviews</button>
          <button class="tab-btn" data-tab="shipping">Delivery</button>
        </div>

        <div class="tab-content">
          <div class="tab-panel active" id="description">
            <div class="magnolia-card">
              <h3>About This Sacred Tool</h3>
              {%- if product.description != blank -%}
                {{ product.description }}
              {%- else -%}
                <p>This sacred tool has been crafted with intention to support your spiritual journey and healing practice.</p>
              {%- endif -%}
            </div>
          </div>

          <div class="tab-panel" id="details">
            <div class="magnolia-card">
              <h3>Product Details</h3>
              <div class="details-grid">
                {%- if product.metafields.midnight_magnolia.product_format -%}
                  <div class="detail-item">
                    <strong>Format:</strong> {{ product.metafields.midnight_magnolia.product_format }}
                  </div>
                {%- endif -%}

                {%- if product.vendor != blank -%}
                  <div class="detail-item">
                    <strong>Creator:</strong> {{ product.vendor }}
                  </div>
                {%- endif -%}

                <div class="detail-item">
                  <strong>SKU:</strong> {{ product.selected_or_first_available_variant.sku | default: 'N/A' }}
                </div>

                {%- if product.tags.size > 0 -%}
                  <div class="detail-item">
                    <strong>Categories:</strong> {{ product.tags | join: ', ' }}
                  </div>
                {%- endif -%}
              </div>
            </div>
          </div>

          <div class="tab-panel" id="reviews">
            <div class="magnolia-card">
              <h3>Customer Reviews</h3>
              {%- comment -%} Reviews integration placeholder {%- endcomment -%}
              <div class="reviews-placeholder">
                <p>Reviews will be displayed here when integrated with a review app.</p>
                <div class="review-summary">
                  <div class="rating-overview">
                    <div class="stars-large">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <span class="rating-text">4.8 out of 5 stars</span>
                  </div>
                  <p class="review-count">Based on {{ product.metafields.reviews.rating_count | default: '12' }} reviews</p>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-panel" id="shipping">
            <div class="magnolia-card">
              <h3>Delivery Information</h3>
              {%- if product.metafields.midnight_magnolia.product_format contains 'Digital' -%}
                <div class="delivery-info">
                  <h4>üì± Digital Download</h4>
                  <p>This is a digital product. You will receive download links immediately after purchase via email.</p>
                  <ul>
                    <li>Instant access after payment confirmation</li>
                    <li>Download links valid for 30 days</li>
                    <li>Lifetime access to your purchases</li>
                    <li>Compatible with all devices</li>
                  </ul>
                </div>
              {%- else -%}
                <div class="delivery-info">
                  <h4>üöö Physical Shipping</h4>
                  <p>This physical product will be shipped to your address.</p>
                  <ul>
                    <li>Free shipping on orders over $50</li>
                    <li>Standard delivery: 5-7 business days</li>
                    <li>Express delivery: 2-3 business days</li>
                    <li>International shipping available</li>
                  </ul>
                </div>
              {%- endif -%}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  {%- comment -%} Related Products {%- endcomment -%}
  {%- if collections[product.metafields.midnight_magnolia.category_tag].products.size > 1 -%}
    <section class="related-products section">
      <div class="container">
        <h2 class="text-center mb-4">More Sacred Tools</h2>

        <div class="grid grid--4-col">
          {%- for related_product in collections[product.metafields.midnight_magnolia.category_tag].products limit: 4 -%}
            {%- unless related_product.id == product.id -%}
              <div class="product-card">
                <div class="product-card__image">
                  {%- if related_product.featured_media -%}
                    <img src="{{ related_product.featured_media | image_url: width: 300 }}"
                         alt="{{ related_product.featured_media.alt | escape }}"
                         loading="lazy">
                  {%- endif -%}
                </div>

                <div class="product-card__content">
                  <h3 class="product-card__title">
                    <a href="{{ related_product.url }}">{{ related_product.title }}</a>
                  </h3>

                  <div class="product-card__price">
                    {{ related_product.price | money }}
                  </div>

                  <a href="{{ related_product.url }}" class="btn btn--ghost w-full">
                    Explore Tool
                  </a>
                </div>
              </div>
            {%- endunless -%}
          {%- endfor -%}
        </div>
      </div>
    </section>
  {%- endif -%}

</div>

{%- comment -%} Product JavaScript {%- endcomment -%}
<script>
  // Change main product image
  function changeMainImage(imageUrl, thumbnail) {
    document.getElementById('main-product-image').src = imageUrl;

    // Update active thumbnail
    document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
    thumbnail.classList.add('active');
  }

  // Quantity controls
  function changeQuantity(change) {
    const quantityField = document.getElementById('quantity');
    const currentValue = parseInt(quantityField.value);
    const newValue = Math.max(1, currentValue + change);
    quantityField.value = newValue;
  }

  // Tab functionality
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabId = btn.dataset.tab;

      // Update active tab button
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Update active tab panel
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    });
  });

  // Add to cart functionality
  document.querySelector('.product-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const addButton = document.querySelector('.add-to-cart-btn');
    const btnText = addButton.querySelector('.btn-text');
    const btnLoading = addButton.querySelector('.btn-loading');

    // Show loading state
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    addButton.disabled = true;

    fetch('/cart/add.js', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      // Success - could trigger cart drawer or notification
      btnText.textContent = '‚ú® Added to Collection!';
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';

      setTimeout(() => {
        btnText.textContent = '‚ú® Add to Sacred Collection';
        addButton.disabled = false;
      }, 2000);
    })
    .catch(error => {
      console.error('Error:', error);
      btnText.textContent = 'Error - Try Again';
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      addButton.disabled = false;
    });
  });
</script>

{%- comment -%} Product Schema Markup {%- endcomment -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Product",
  "name": "{{ product.title | escape }}",
  "description": "{{ product.description | strip_html | escape }}",
  "image": [
    {%- for media in product.media limit: 5 -%}
      "{{ media | image_url: width: 600 }}"{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ],
  "brand": {
    "@type": "Brand",
    "name": "{{ product.vendor | default: shop.name | escape }}"
  },
  "offers": {
    "@type": "Offer",
    "url": "{{ shop.url }}{{ product.url }}",
    "priceCurrency": "{{ cart.currency.iso_code }}",
    "price": "{{ product.price | divided_by: 100.0 }}",
    "availability": "{% if product.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
    "seller": {
      "@type": "Organization",
      "name": "{{ shop.name | escape }}"
    }
  }
}
</script>